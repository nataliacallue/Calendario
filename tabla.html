<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tabla de Presupuesto</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="MiCalendario">
  <meta name="theme-color" content="#ffde21">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .custom-pdf-btn {
      position: absolute;
      right: 0;
      background-color: white;
      border: 2px solid #dc3545;
      color: #dc3545;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .custom-pdf-btn:hover {
      background-color: #dc3545;
      color: white;
    }

    /* Oculta el botÃ³n al imprimir o exportar */
    @media print {
      #downloadPDF {
        display: none !important;
      }
    }
  </style>
</head>

<body class="bg-light">

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom mb-3">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#"></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link" href="index.html">Calendario</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="tabla.html">Tabla</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container py-4" id="contentToPrint">
  <h3 class="text-center mb-4">Desglose de Extras</h3>

  <!-- Filtro mes/aÃ±o + botÃ³n PDF -->
  <div class="d-flex justify-content-center align-items-center gap-2 mb-3 position-relative">
    <div class="d-flex justify-content-center gap-2">
      <select id="monthSelect" class="form-select w-auto"></select>
      <select id="yearSelect" class="form-select w-auto"></select>
    </div>
    <button id="downloadPDF" class="btn btn-outline-danger custom-pdf-btn">ðŸ“„ Descargar PDF</button>
  </div>

  <!-- Tabla -->
  <table class="table table-striped table-bordered" id="budgetTable">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Evento</th>
        <th>Desglose</th>
        <th>Precio (â‚¬)</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <th colspan="3" class="text-end">Total:</th>
        <th id="totalPrice">0.00</th>
      </tr>
    </tfoot>
  </table>
</div>

<!-- JS de Bootstrap, html2canvas, jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const events = JSON.parse(localStorage.getItem("calendarEvents")) || {};
const tbody = document.querySelector("#budgetTable tbody");
const totalPriceEl = document.getElementById("totalPrice");
const monthSelect = document.getElementById("monthSelect");
const yearSelect = document.getElementById("yearSelect");

const monthNames = [
  "Enero","Febrero","Marzo","Abril","Mayo","Junio",
  "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
];

// Inicializar selectores
function initSelectors() {
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth();

  monthNames.forEach((name, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = name;
    if (i === currentMonth) opt.selected = true;
    monthSelect.appendChild(opt);
  });

  for (let y = currentYear - 1; y <= currentYear + 2; y++) {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    if (y === currentYear) opt.selected = true;
    yearSelect.appendChild(opt);
  }
}

// Calcular clases extra
function calcularClasesExtra(numClases, fechaStr) {
  const rows = [];
  const fecha = new Date(fechaStr);
  const esSabado = fecha.getDay() === 6;

  if (esSabado) {
    for (let i = 1; i <= numClases; i++) rows.push({desc: `Clase ${i}`, precio: 15.71});
  } else {
    if (numClases >= 1) rows.push({desc: "Clase 1", precio: 19});
    for (let i = 2; i <= numClases; i++) rows.push({desc: `Clase ${i}`, precio: 15.71});
  }
  return { rows, esSabado };
}

// Renderizar tabla
function renderTable() {
  tbody.innerHTML = "";
  let totalPrice = 0;
  const month = parseInt(monthSelect.value);
  const year = parseInt(yearSelect.value);

  const sortedEvents = Object.entries(events)
    .map(([date, e]) => ({ date, ...e }))
    .filter(e => {
      const d = new Date(e.date);
      return d.getMonth() === month && d.getFullYear() === year;
    })
    .sort((a, b) => {
      const order = { "extra": 1, "examen": 2, "call": 3 };
      if (a.date === b.date)
        return (order[a.type || (a.call ? "call" : "")] || 99) -
               (order[b.type || (b.call ? "call" : "")] || 99);
      return new Date(a.date) - new Date(b.date);
    });

  sortedEvents.forEach(e => {
    const fechaObj = new Date(e.date);
    const fechaStr = `${fechaObj.getDate().toString().padStart(2, "0")}/${(fechaObj.getMonth() + 1).toString().padStart(2, "0")}/${fechaObj.getFullYear()}`;

    if (e.type === "extra") {
      const { rows: clases, esSabado } = calcularClasesExtra(e.clases, e.date);
      const eventoTexto = esSabado ? `${e.clases} ext sÃ¡bado` : `${e.clases} ext`;

      clases.forEach((c, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          ${i === 0 ? `<td rowspan="${clases.length}">${fechaStr}</td><td rowspan="${clases.length}">${eventoTexto}</td>` : ""}
          <td>${c.desc}</td>
          <td>${c.precio.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
        totalPrice += c.precio;
      });
    }

    if (e.type === "examen") {
      const tr = document.createElement("tr");
      const precio = e.alumnos * 5;
      tr.innerHTML = `
        <td>${fechaStr}</td>
        <td>Examen</td>
        <td>${e.alumnos} alumno(s)</td>
        <td>${precio.toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
      totalPrice += precio;
    }

    if (e.call) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${fechaStr}</td>
        <td>Llamada post-examen</td>
        <td>1 llamada</td>
        <td>20.00</td>
      `;
      tbody.appendChild(tr);
      totalPrice += 20;
    }
  });

  totalPriceEl.textContent = totalPrice.toFixed(2);
}

// Descargar PDF
document.getElementById("downloadPDF").addEventListener("click", async () => {
  const downloadBtn = document.getElementById("downloadPDF");
  downloadBtn.style.display = "none";

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("portrait", "mm", "a4");

  const month = parseInt(monthSelect.value);
  const year = parseInt(yearSelect.value);
  const title = `Presupuesto â€” ${monthNames[month]} ${year}`;

  const content = document.getElementById("contentToPrint");
  const canvas = await html2canvas(content, { scale: 2 });
  const imgData = canvas.toDataURL("image/png");

  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const imgWidth = pageWidth - 20;
  const imgHeight = (canvas.height * imgWidth) / canvas.width;

  let y = 10;
  pdf.setFontSize(14);
  pdf.text(title, 10, y);
  y += 10;

  if (imgHeight < pageHeight - 20) {
    pdf.addImage(imgData, "PNG", 10, y, imgWidth, imgHeight);
  } else {
    let position = 0;
    while (position < imgHeight) {
      pdf.addImage(imgData, "PNG", 10, y - position, imgWidth, imgHeight);
      position += pageHeight - 20;
      if (position < imgHeight) pdf.addPage();
    }
  }

  pdf.save(`Desglose_Extras_${monthNames[month]}_${year}.pdf`);
  downloadBtn.style.display = "inline-block";
});

// InicializaciÃ³n
initSelectors();
renderTable();
monthSelect.addEventListener("change", renderTable);
yearSelect.addEventListener("change", renderTable);
</script>
</body>
</html>
